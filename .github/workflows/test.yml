name: Test apps 
run-name: Test ${{ github.ref_name }}

on:
  workflow_dispatch
    
jobs:
  test-apps:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Work
        run: |
          echo virtualbox-ext-pack virtualbox-ext-pack/license select true | sudo debconf-set-selections
          sudo apt install -y virtualbox virtualbox-ext-pack
          cd /tmp
          ip addr
          echo "RFX: wget"
          #wget --progress=dot:giga https://updates.software-univention.de/download/images/UCS-Virtualbox-Image.ova
          wget --progress=dot:giga https://getfile.dokpub.com/yandex/get/https://disk.yandex.ru/d/lXogIl348sFBWw
          mv lXogIl348sFBWw USC-VB-Image.part.aa
          wget --progress=dot:giga https://getfile.dokpub.com/yandex/get/https://disk.yandex.ru/d/yxYi2eeh24vrvA
          mv yxYi2eeh24vrvA USC-VB-Image.part.ab
          echo "RFX: cat"
          cat USC-VB-Image.part.* > UCS-Virtualbox-Image.ova
          echo "RFX: ls"
          ls
          echo "RFX: import"
          sudo VBoxManage import /tmp/UCS-Virtualbox-Image.ova --vsys 0 --eula accept
          #ping -c 10 127.0.0.1
          echo "RFX: list"
          sudo VBoxManage list vms
          echo "RFX: start"
          sudo VBoxManage startvm "UCS 5.2-2" --type headless
          ping -c 20 127.0.0.1
          echo "RFX: run"
          echo "\nroot\n" > run.txt
          sudo VBoxManage controlvm "UCS 5.2-2" keyboardputfile ./run.txt
          ping -c 1 127.0.0.1
          echo "onlyoffice\n" > run.txt
          sudo VBoxManage controlvm "UCS 5.2-2" keyboardputfile ./run.txt
          ping -c 1 127.0.0.1
          echo "apt install -y build-essential virtualbox-guest-additions-iso\n" > run.txt
          sudo VBoxManage controlvm "UCS 5.2-2" keyboardputfile ./run.txt
          ping -c 40 127.0.0.1
          echo "mkdir -p /mnt/lp1\n" > run.txt
          sudo VBoxManage controlvm "UCS 5.2-2" keyboardputfile ./run.txt
          ping -c 1 127.0.0.1
          echo "mount -o loop /usr/share/virtualbox/VBoxGuestAdditions.iso /mnt/lp1\n" > run.txt
          sudo VBoxManage controlvm "UCS 5.2-2" keyboardputfile ./run.txt
          ping -c 5 127.0.0.1
          echo "/mnt/lp1/VBoxLinuxAdditions.run\n" > run.txt
          sudo VBoxManage controlvm "UCS 5.2-2" keyboardputfile ./run.txt
          ping -c 10 127.0.0.1
          echo "reboot\n" > run.txt
          sudo VBoxManage controlvm "UCS 5.2-2" keyboardputfile ./run.txt
          ping -c 30 127.0.0.1
          echo "RFX: get ip"
          sudo VBoxManage guestcontrol "UCS 5.2-2" run --exe "/usr/bin/ip" --username root --password onlyoffice --wait-stdout -- -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'

